==文字需要大改==

## 分类

工作模式主要分为分组密码模式和流密码模式, 分组密码模式又分为有反馈和无反馈. 分组密码借助密码算法的加解密模块实现加解密, 流密码借助生成乱源流密钥进行加解密.

- 电码本模式 ECB
- 密文分组链接模式 CBC
- 密码反馈模式 CFB
- 输出反馈模式 OFB
- 计数器模式 CTR

> 具体编程实现见[自制密码库](../文档/自制密码库.md)

## 电话本模式 ECB
ECB: electronic codebook
每个明文组独立地以同一密钥加密 –> 传送短数据

- 给定密钥时, 同一明文组总产生同样的密文组
- 传递短消息安全; 长消息(很多组)时, 容易被找出文本结构和重复.
- 加密解密结构相同, 容易被*重放攻击*, 不提供严格数据保密性  

![|275](../../attach/Pasted%20image%2020230612153447.png)

## 密码分组链接 CBC
CBC: cipher-block chaining
加密算法的输入是当前明文组与前一密文组的异或 -> 传送数据分组；认证

- 重复的明文分组不会暴露
- **加密过程**为: $C_{n} = EK{[C_{n-1}\oplus P_{n}]}\ ,\ \ C_{0}=IV\ (initial\ vector)$
- 串行加密, 无法并行化; 由于密钥已知, 所以解密可以并行(事实上, 解密只取决于$C_{n-1}$和$C_{n}$). 前明文的微小改变会引起后续全部密文变化, 但解密密文变化不会引起雪崩.
- 初始矢量IV需要双方都已知, 并且需要保密, 可以使用ECB模式来传输.

![|650](../../attach/Pasted%20image%2020230612112531.png)

> 如果IV保护不当, 攻击者给接收方假的$IV'$, 即IV的反  
> 接收方收到$C_{n}=E_{k}[IV\oplus P_{n}]$, 解密为$IV\oplus P_{n}$, 和假的$IV'$进行异或, $IV \oplus P_{n}\oplus IV'=P_{n}'$  
> 攻击者可以选择某些位对接收者解密出的明文bit取反, 从而破坏明文信息

## 密码反馈模式 CFB

CFB: cipher feedback  
每次只处理输入的j比特，将上一次密文作加密算法的输入以产生伪随即输入，该输入再与当前明文异或以产生当前密文 -> 传送数据流；认证

- **将分组对称密码转换为流密码**, 流密码不需要块填充, 实时运行(当然,有密钥长度必须和密文一样长的缺点). 
- 将明文分成长度为s的单元, 通过移位不断更新前s位密钥. **加密过程**: $C_{i}=P_{i}\ \oplus\ SE_{s}[\ E_{k}(\ SH_{s}[\ C_{i-1}])],\ \ C_{0}=IV$; 注意移位不是传统的循环移位, 新的后s位是上一轮的密文.
- **解密**直接使用加密模块, 不需要重复实现, 解密可以并行(加密不行).
- 和CBC区别是, 明文使用流密钥的异或加密方式, 而不参与*当前轮*的密钥(乱源)生成. 流密码加解密都采用Encrypt模块, 这是因为此后Encrypt的输入不再是P, P采用异或轮密钥方式加密, 所以每轮Enc的输出都不知道, 只能采用复现轮密钥的方法, 而不是逆变换的方法.
- 安全性: 能检测出篡改? 除了保密性还能用于认证; 但对信道错误敏感, 仍需要IV

```ad-question
- 为什么CFB不用填充? 最后一轮长度不够s怎么办? 还是说是在已知密钥长度情况下, 取了一个能整除密钥长度的s?
	不用填充！也不用刻意取s。先看最后异或，要解密t(t<s)位P，只需要t位C和它异或。同时密钥扩展也不需要最后的C(t length)，只取扩展密钥前t位

- 为什么对信道错误敏感? 解密过程不是只需要两组密文吗?

- 并行解密时，Shift盒原始数据从哪里来？
	还是IV和Ci的排列而已。
```

![|700](../../attach/Pasted%20image%2020230612161515.png)

## 输出反馈模式 OFB

与CFB不同在于 本次加密算法的输入是前一次加密算法的输出 -> 噪声信道（如卫星通讯）传送数据流. OFB也有移位寄存器, 但课本上没有详细给出.

- 在CFB基础上，密钥生成的输入不再是上一轮密文，而是上一轮轮密钥(前s位,**仍有shift和select函数**)
- 密钥生成仍然不能并行化, 但是可以提前将轮密钥全部生成，然后对明文和轮密钥进行并行异或处理。
- **可以使用输入为0的CBC来模拟OFB的密钥生成**
- 安全性: 不适合认证; 传输过程出错只对当前单位明文有影响, 可以用于卫星等有扰信道; 比CFB更容易受到篡改攻击, 没有自同步能力

```ad-question
安全性就没一条理解了
```
![|350](../../attach/Pasted%20image%2020230612114011.png)

## 计数器模式 CTR
CTR: counter mode, also called: Integer Counter Mode (ICM) or Segemented Integer Counter (SIC)
对计数器依次用k加密后与明文异或 -> 适合并行，可随机访问

- 计数器可以是一个加密计数器, 也可以是任意保证*不长时间重复输出*的函数
- 可并行, 可预处理(明文不参与密钥生成), 加密数据块可以随机访问(比如访问第n块, 计数器直接加n; 或者说f(x)中x直接取n)

![|400](../../attach/Pasted%20image%2020230613202211.png)

基于CTR, 还有GCM等模式


|        | ECB              | CBC                                         | CFB                                                                       | OFB                                                           | CTR                          |
| ------ | ---------------- |:------------------------------------------- | ------------------------------------------------------------------------- | ------------------------------------------------------------- | ---------------------------- |
| 加密递推式  | $C_i=Enc(P_i,k)$ | $C_i=Enc(C_{i-1}\oplus P_i,k)$<br/>$C_0=IV$ | $rk_i=Enc(rk_{i-1}[:-s]\ \|\ C_{i-1},\ k)$<br/>$C_i=P_i\oplus rk_{i}[:s]$ | $rk_i=Enc(rk_{i-1},k)$<br/>$rk_0=IV$<br/>$C_i=rk_i\oplus P_i$ | $C_i=Enc(cnt_i,k)\oplus P_i$ |
| 解密递推式  | $P_i=Dec(C_i,k)$ | $P_i=C_{i-1}\oplus Dec(C_i,k)$              | $P_i=C_i\oplus rk_{i}[:s]$                                                | $P_i=rk_i\oplus C_i$                                          | $P_i=Enc(cnt_i,k)\oplus C_i$ |
| 初始向量   | N                | Y                                           | Y                                                                         | Y                                                             | Y                            |
| 加密并行性  | Y                | N                                           | N                                                                         | Y                                                             | Y                            |
| 解密并行性  | Y                | Y                                           | Y                                                                         | Y                                                             | Y                            |
| 需要解密模块 | Y                | Y                                           | N                                                                         | N                                                             | N                            |
| 含有反馈   | N                | Y                                           | Y                                                                         | Y                                                             | N                            |
